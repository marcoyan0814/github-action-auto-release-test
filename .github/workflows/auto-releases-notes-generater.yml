name: Deploy to release

# 手動觸發，在 action 右上點 run workflow 選 main 並且輸入要發佈的版本號碼(ex: v0.0.1)
on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release'
        required: true

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    name: Release ${{ inputs.version }}
    outputs:
      version: ${{ steps.version.outputs.version }}
      notes: ${{ steps.changelog.outputs.changes }}

    steps:
      # checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # 取得輸入的版本號碼
      - name: Remove optional "v" prefix
        id: version
        run: |
          VERSION=${{ inputs.version }}
          echo "version=${VERSION#v}" >> "$GITHUB_OUTPUT"

      # 更新版本號碼
      - name: Update Application.php version
        run: echo v${{ steps.version.outputs.version }} > version.txt

      - name: Commit version change
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          branch: main
          commit_message: 'docs: Update version to v${{ steps.version.outputs.version }}'
          file_pattern: 'version.txt'

      - name: Create new tag
        run: |
          git tag v${{ steps.version.outputs.version }}
          git push --tag

      # 產生changelog及tag
      - name: Update CHANGELOG
        id: changelog
        uses: requarks/changelog-action@v1
        with:
          token: ${{ github.token }}
          tag: v${{ steps.version.outputs.version }}
          excludeTypes: build

      - name: Commit CHANGELOG.md
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          branch: main
          commit_message: 'docs: update CHANGELOG.md for v${{ steps.version.outputs.version }}'
          file_pattern: CHANGELOG.md

      - name: Create release
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: v${{ steps.version.outputs.version }}
          body: ${{ steps.changelog.outputs.changes }}
          target_commitish: ${{ github.ref_name }}
          make_latest: 'legacy'
